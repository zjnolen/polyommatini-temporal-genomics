---
title: "Figure 1: Sampling, genetic diversity and differentiation"
format:
  html:
    code-fold: true
---

The first figure focuses on changes in genetic diversity and differentiation
over time, and introduces the sampling area and focal species.

```{r}
#| label: load-packages
#| code-summary: Load up required packages and setup species and genome lists

library(data.table) # For reading in data while skipping columns
library(stringr) # For separating pop names into regions and sampling years
library(ggplot2) # For plotting
library(ggpubr) # For adding stats to graphs
library(cowplot) # For arranging plots into a multi-panel figure
library(ggtext) # For more control over axis text layout
library(dplyr) # For summarize function and piping
library(geosphere) # For including distances on F~ST~ plot
library(scales) # For some control of plot scales
library(png) # For reading in maps made in QGIS
library(grid) # For plotting maps made in QGIS with ggplot

species <- c("picarus", "pargus", "csemiargus")
genomes <- c("ilPolIcar1.1", "ilPleArgu1.3", "ilCyaSemi1.1")
```

## Heterozygosity

For heterozygosity, read in the individual heterozygosity results from ANGSD.
These are genome-wide average estimates of heterozygous sites per 1000bp. They
also have a confidence interval for this from bootstraps of the single sample
SFS. Since this is mixing modern and historical samples with DNA damage, these
estimates are made excluding transitions.

```{r}
#| label: read-heterozygosity

hz_all <- c()

for (i in c(1:length(species))) {
  s <- species[i]
  g <- genomes[i]
  hz <- fread(
    paste0(
      "../angsd/results/datasets/historical-",
      s,
      "-notrans/analyses/heterozygosity/historical-",
      s,
      "-notrans.",
      g,
      "_all_allsites-filts_heterozygosity.tsv"
    ),
    header = TRUE,
    sep = "\t"
  )
  samples <- fread(
    paste0(
      "../angsd/results/datasets/historical-",
      s,
      "-notrans/poplists/historical-",
      s,
      "-notrans_all.indiv.list"
    ),
    header = TRUE,
    sep = "\t",
    select = c("sample", "population", "time", "depth")
  )
  hz <- merge(hz, samples, by = "sample")
  hz$species <- s
  hz_all <- rbind(hz_all, hz)
}

hz_all$year <- str_sub(hz_all$population, -4, -1)
hz_all$region <- str_sub(hz_all$population, 1, -5)

hz_all$species <- factor(
  hz_all$species,
  levels = species,
  labels = c("P. icarus", "P. argus", "C. semiargus")
)

hz_all$time <- factor(
  hz_all$time,
  levels = c("historical", "modern"),
  labels = c("Historical", "Modern")
)

hz_all$region <- factor(
  hz_all$region,
  levels = c("WSkane", "SWSkane", "ESkane", "SESkane", "NSmaland", "Oland"),
  labels = c(
    "W Skåne", "SW Skåne", "E Skåne", "SE Skåne", "N Småland", "Öland"
  )
)
```

Plot the heterozygosity by species. Show points colored by the sampled
areas, but group time periods together in a single boxplot.

```{r}
#| label: fig-het-box
#| fig-width: 6
#| fig-height: 2.5

hzbox <- ggplot(hz_all, aes(x = time, y = heterozygous_per_1000bp, color = region)) +
  facet_grid(cols = vars(species)) +
  geom_boxplot(
    aes(x = time, y = heterozygous_per_1000bp),
    inherit.aes = FALSE,
    outliers = FALSE
  ) +
  geom_point(
    aes(color = region),
    position = position_jitterdodge(jitter.width = 0.05)
  ) +
  ylab("<span style='font-size: 9pt'>Heterozygous sites per 1000bp</span><br><span style='font-size: 7pt'>(excl. transitions)</span>") +
  scale_color_manual(
    values = c("#244F6E", "#244F6E", "#658399", "#658399", "#8A2A3B", "#fecd03"),
    name = "Geographic Region"
  ) +
  theme_bw() +
  theme(
    legend.position.inside = c(0.08, 0.35),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_markdown(),
    strip.text.x = element_text(size = 10, face = "italic")
  )

hzbox
```

## Inbreeding coefficients

Next, we read in the inbreeding coefficients calculated from runs of
homozygosity > 100kb in each sample. For these, genotypes are called per sample,
only including genotypes with sequencing depth >=6 and an allelic balance from
0.2-0.8 for heterozygous genotypes. Only samples with >5X average sequencing
depth in the filtered region are included.

Each species then has all samples merged, removing variants fixed across the
dataset, as well as SNPs within 5bp of indels along with indels themselves.
Finally, to account for DNA damage, all transition variants are removed. These
variants are then run through bcftools roh to estimate IBD tracts, using a
rough species specific recombination rate (assuming 50cM per chr), setting a
default minor allele frequency, and ignoring homozygous reference genotypes.
This pattern of filtering mimics how bcftools would handle a single sample roh
analysis, but with the benefit of allowing removal of variants fixed in the
dataset as homozygous alternate. These variants can skew roh estimation, as they
likely are not segregating in the sample area, but will be treated as having
a default minor allele frequency of 0.4, which would create a bias in the model
based on how diverged the sample set is from the reference.

```{r}
#| label: read-froh

froh_all <- c()

for (i in c(1:length(species))) {
  s <- species[i]
  g <- genomes[i]
  froh <- fread(
    paste0(
      "../angsd/results/datasets/historical-",
      s,
      "-notrans/plots/inbreeding/historical-",
      s,
      "-notrans.",
      g,
      "_all_allsites-filts.filtered_mindp6-biallelic.notrans.fmiss0.2.bcftools.ind_froh.tsv"
    ),
    header = TRUE,
    sep = "\t",
    select = c("sample", "population", "time", "depth", "Froh")
  )
  froh$species <- s
  froh_all <- rbind(froh_all, froh)
}

froh_all$year <- str_sub(froh_all$population, -4, -1)
froh_all$region <- str_sub(froh_all$population, 1, -5)

froh_all$species <- factor(
  froh_all$species,
  levels = species,
  labels = c("P. icarus", "P. argus", "C. semiargus")
)

froh_all$time <- factor(
  froh_all$time,
  levels = c("historical", "modern"),
  labels = c("Historical", "Modern")
)

froh_all$region <- factor(
  froh_all$region,
  levels = c("WSkane", "SWSkane", "ESkane", "SESkane", "NSmaland", "Oland"),
  labels = c("W Skåne", "SW Skåne", "E Skåne", "SE Skåne", "N Småland", "Öland")
)
```

Plot these the same way as heterozygosity.

```{r}
#| label: fig-froh-box
#| fig-width: 6
#| fig-height: 2.5

frohbox <- ggplot(froh_all, aes(x = time, y = Froh, color = region)) +
  facet_grid(cols = vars(species)) +
  geom_boxplot(
    aes(x = time, y = Froh),
    inherit.aes = FALSE,
    outliers = FALSE
  ) +
  geom_point(
    aes(color = region),
    position = position_jitterdodge(jitter.width = 0.05)
  ) +
  ylab("<span style='font-size: 9pt'>*F~RoH~* </span><span style='font-size: 7pt'>(*RoH* > 100kb)</span>") +
  scale_color_manual(
    values = c("#244F6E", "#244F6E", "#658399", "#658399", "#8A2A3B", "#fecd03"),
    name = "Geographic Region"
  ) +
  theme_bw() +
  theme(
    legend.position.inside = c(0.08, 0.35),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_markdown(),
    strip.text.x = element_text(size = 10, face = "italic")
  )

frohbox
```


## Population differention using *F~ST~*

As a measure of population differentiation, we use pairwise population *F*~ST~.
This is estimated in ANGSD using the Bhatia estimator, which is more robust to
lower sample sizes. We compare these values within species, visualizing as a
difference in *F*~ST~ between equivalent historical and modern population pairs,
including their geographic distance in the visualization.

```{r}
#| label: read-fst

fst_all <- c()

# read in F_ST results for population pairs
for (i in c(1:length(species))) {
  s <- species[i]
  g <- genomes[i]
  fst <- fread(
    paste0(
      "../angsd/results/datasets/historical-",
      s,
      "-notrans/analyses/fst/historical-",
      s,
      "-notrans.",
      g,
      "_poppairs_allsites-filts.fst.global.tsv"
    ),
    header = TRUE,
    sep = "\t",
    select = c("pop1", "pop2", "unweight.fst", "weight.fst")
  )
  fst$species <- s
  fst_all <- rbind(fst_all, fst)
}

fst <- fst_all

# Read in sampling info, including coordinates
regions <- read.table("../config/pop_groups.tsv", header = TRUE)

# Merge sampling info with F_ST data
fst <- merge(fst, regions, by.x = "pop1", by.y = "population")
fst <- merge(fst, regions, by.x = "pop2", by.y = "population")

# Get rid of pairs within same time period, get pair 'name', and set time
# categories for pair
fst <- fst[abs(fst$year.x - fst$year.y) < 60, ]
fst$pair <- paste0(fst$region.x, "-", fst$region.y)
fst$time <- "placeholder"
fst[fst$year.x < 2000, ]$time <- "historical"
fst[fst$year.x > 2000, ]$time <- "modern"
# Calculate distance between population pairs
fst$dist <- as.vector(
  apply(
    fst, 1, function(x) distm(c(x[9], x[8]), c(x[13], x[12]), fun = distGeo)
  )
)
# Set F_ST < 0 to 0 (this comes from the optimization in ANGSD and doesn't have
# any biological meaning different than 0)
fst$weight.fst[fst$weight.fst < 0] <- 0
# Remove pairs where populations contain single samples
fst <- fst[!fst$pop2 %in% c("ESkane1917", "WSkane1943"), ]
fst <- fst[!fst$pop1 %in% c("ESkane1917", "WSkane1943"), ]

# Set up variables for plotting
fst$species <- factor(
  fst$species,
  levels = c("picarus", "pargus", "csemiargus"),
  labels = c("P. icarus", "P. argus", "C. semiargus")
)
fst$time <- factor(
  fst$time,
  levels = c("historical", "modern"),
  labels = c("Historical", "Modern")
)

```

```{r}
#| label: fig-fst-box
#| fig-width: 6
#| fig-height: 2.5

fstplot <- ggplot(fst, aes(x = time, y = weight.fst, group = pair, col = dist / 1000, label = paste0(round(dist / 1000, 1), " km"))) +
  geom_line(linewidth = 0.5) +
  geom_point(size = 2.5) +
  # geom_text_repel() +
  facet_grid(cols = vars(species)) +
  theme_bw() +
  scale_color_gradient(low = "#55AFF4", high = "#132C44", name = "Distance (km)") +
  ylab("<span style='font-size: 9pt'>Weighted *F~ST~*</span>") +
  scale_y_continuous(labels = number_format(accuracy = 0.01)) +
  guides(
    colour = guide_colourbar(position = "inside")
  ) +
  theme(
    legend.background = element_rect(color = "black", size = 0.2),
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 7),
    legend.key.size = unit(0.4, "cm"),
    legend.justification.inside = c(0.02, 0.9),
    axis.title.x = element_blank(),
    panel.grid = element_blank(),
    axis.title.y = element_markdown(),
    strip.text = element_text(face = "italic", size = 10)
  )

fstplot
```


## Combined figure

We use cowplot in R to arrange these figures to produce a final figure for the
manuscript. This figure also includes a map prepared in QGIS and photos I've
taken of the butterflies.

```{r}
#| label: fig-diversity
#| fig-width: 10.5
#| fig-height: 7

arrhz <- hzbox +
  theme(
    legend.position = "none"
    # axis.text.x = element_blank(),
    # plot.margin = unit(c(0, 0, 0, 0), "cm")
  )

arrfroh <- frohbox +
  theme(
    legend.position = "none"
    # axis.text.x = element_blank(),
    # strip.text.x = element_blank(),
    # strip.background = element_blank(),
    # plot.margin = unit(c(0, 0, 0, 0), "cm")
  )

arrfst <- fstplot

map <- readPNG("../resources/gis/sampling_map/historical_map.png")
map <- rasterGrob(map, interpolate = TRUE)
map <- ggplot() +
  geom_blank() +
  annotation_custom(map, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf)

butterflies <- readPNG("../images/butterfly_species_photos.png")
butterflies <- rasterGrob(butterflies, interpolate = TRUE)
butterflies <- ggplot() +
  geom_blank() +
  annotation_custom(
    butterflies,
    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
  )

map_photos <- plot_grid(
  butterflies, map,
  labels = c("A", "B"),
  nrow = 2,
  ncol = 1,
  rel_heights = c(0.4, 1)
)

plot_grid(map_photos,
  plot_grid(arrhz, arrfroh, arrfst, ncol = 1, nrow = 3, labels = c("C", "D", "E"), align = "v", axis = "lr"),
  ncol = 2, nrow = 1
)

ggsave("../figures/genetic-diversity.png", dpi = 600, create.dir = TRUE, bg = "white")
```